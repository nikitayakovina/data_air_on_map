import {Component, OnInit} from '@angular/core';
import {LocationService} from "../../service/location-service.service";
import {MarkersService} from "../../service/markers-service.service";
import {SensorsService} from "../../service/sensors-service.service";
import {ColorAir} from "../shared/enums";
import * as moment from "moment";
import {RequestsService} from "../../service/requests-service.service";
import bbox from '@turf/bbox';
import * as turf from '@turf/turf';
import { WeatherService } from 'src/service/weather-service.service';

@Component({
  selector: 'app-yandex-maps',
  templateUrl: './yandex-maps.component.html',
  styleUrls: ['./yandex-maps.component.css']
})
export class YandexMapsComponent implements OnInit {
  public colorWell = ColorAir.Well;
  public colorMedium = ColorAir.Medium;
  public colorBad = ColorAir.Bad;
  public colorVeryBad = ColorAir.VeryBad;
  public colorVeryVeryBad = ColorAir.VeryVeryBad;
  private _center: Array<number> = [];
  public get center(): Array<number> {
    return this._center;
  }
  constructor(
    private locationService: LocationService,
    private markersService: MarkersService,
    private sensorsService: SensorsService,
    private requestsService: RequestsService, 
    private weatherService: WeatherService) {}

  public ngOnInit(): void {
    this.locationService.getPositions().then(result => {
      this._center.push(result.lat, result.lng);
      ymaps.ready(() => {
        this.yandexMaps(result.lat, result.lng);
      });
    });
  }

  public doForecasts(coord: any): void {
    this.requestsService.getForecasts(coord).subscribe(res => {
      return res;
    })
  }
  
  public yandexMaps(lat: any, lng: any): void {
    const myMap = new ymaps.Map('map',
    {
      center: [lat, lng],
      zoom: 12,
      controls: ['zoomControl']
    },
    {
      minZoom: 5,
      maxZoom: 22,
      // restrictMapArea: [
      //   [55.141278, 73.057086],
      //   [54.818015, 73.646356]
      // ]
    });

    const myGeoObject = new ymaps.GeoObject({
      geometry: {
        type: "Point",
        coordinates: [lat, lng]
      }
    });
    myMap.geoObjects.add(myGeoObject);

    const json = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.47536087036133,
                  55.04140120974331
                ],
                [
                  73.42654466629028,
                  55.043113239499974
                ],
                [
                  73.40497970581055,
                  55.02467664072859
                ],
                [
                  73.45132827758789,
                  55.02300379987702
                ],
                [
                  73.47536087036133,
                  55.04140120974331
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.45149993896484,
                  55.022905395299844
                ],
                [
                  73.40532302856445,
                  55.02477504095749
                ],
                [
                  73.38523864746094,
                  55.00125051509462
                ],
                [
                  73.45218926668166,
                  54.997322008312935
                ],
                [
                  73.45149993896484,
                  55.022905395299844
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.45231801271439,
                  54.99734431734816
                ],
                [
                  73.4274673461914,
                  54.97741663850396
                ],
                [
                  73.44154357910156,
                  54.93069273527211
                ],
                [
                  73.49664688110352,
                  54.93907549187026
                ],
                [
                  73.49081039428711,
                  54.97830327575534
                ],
                [
                  73.45231801271439,
                  54.99734431734816
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.45218658447266,
                  54.99731200770691
                ],
                [
                  73.40755462646484,
                  54.999872081488654
                ],
                [
                  73.39656829833984,
                  54.93217217222987
                ],
                [
                  73.4413719177246,
                  54.930791366095626
                ],
                [
                  73.42729568481445,
                  54.97761367069628
                ],
                [
                  73.45218658447266,
                  54.99731200770691
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.39622497558594,
                  54.93227079942556
                ],
                [
                  73.40703964233398,
                  54.999675158535794
                ],
                [
                  73.37030410766602,
                  54.98125859185978
                ],
                [
                  73.37905883789062,
                  54.96795795620362
                ],
                [
                  73.37957382202148,
                  54.954455769924145
                ],
                [
                  73.35554122924803,
                  54.9353281225344
                ],
                [
                  73.39622497558594,
                  54.93227079942556
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.40721130371094,
                  55.00006900347498
                ],
                [
                  73.38523864746094,
                  55.001348972825575
                ],
                [
                  73.36000442504883,
                  55.015229093962695
                ],
                [
                  73.33425521850586,
                  55.00115205712201
                ],
                [
                  73.37064743041992,
                  54.981554111505794
                ],
                [
                  73.40721130371094,
                  55.00006900347498
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.41922760009766,
                  55.05920028485005
                ],
                [
                  73.40927124023438,
                  55.06559028730859
                ],
                [
                  73.35382461547852,
                  55.042089718836884
                ],
                [
                  73.37699890136719,
                  55.028514070655504
                ],
                [
                  73.41922760009766,
                  55.05920028485005
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.3769130706787,
                  55.02861246146342
                ],
                [
                  73.3538031578064,
                  55.04207742413539
                ],
                [
                  73.33150863647461,
                  55.03092457591189
                ],
                [
                  73.35983276367186,
                  55.01535212320113
                ],
                [
                  73.3769130706787,
                  55.02861246146342
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.35970401763916,
                  55.015278305703355
                ],
                [
                  73.33148717880249,
                  55.030899979651686
                ],
                [
                  73.30249786376953,
                  55.01773881572826
                ],
                [
                  73.33425521850586,
                  55.0015951160958
                ],
                [
                  73.35970401763916,
                  55.015278305703355
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.34071397781372,
                  55.03563448148282
                ],
                [
                  73.35361540317535,
                  55.04228335988717
                ],
                [
                  73.36768627166748,
                  55.04816283998316
                ],
                [
                  73.32069396972655,
                  55.05821711700218
                ],
                [
                  73.32670211791992,
                  55.028796943577206
                ],
                [
                  73.34071397781372,
                  55.03563448148282
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.32043647766113,
                  55.05826627596805
                ],
                [
                  73.30541610717773,
                  55.07497682516846
                ],
                [
                  73.26464653015137,
                  55.064558125227364
                ],
                [
                  73.29606056213379,
                  55.0470564695103
                ],
                [
                  73.32043647766113,
                  55.05826627596805
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.32051157951354,
                  55.058223261876215
                ],
                [
                  73.29314231872559,
                  55.041991361119486
                ],
                [
                  73.32661628723143,
                  55.02880924235459
                ],
                [
                  73.32051157951354,
                  55.058223261876215
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.32648754119873,
                  55.02877234601108
                ],
                [
                  73.2930564880371,
                  55.041929887423485
                ],
                [
                  73.28061103820801,
                  55.02206894664009
                ],
                [
                  73.30159664154053,
                  55.017640398226355
                ],
                [
                  73.32648754119873,
                  55.02877234601108
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.32019507884979,
                  55.0581433784402
                ],
                [
                  73.29608201980591,
                  55.04701344337447
                ],
                [
                  73.28173756599426,
                  55.05492947415148
                ],
                [
                  73.2681655883789,
                  55.051383433362645
                ],
                [
                  73.27262878417969,
                  55.04563043581564
                ],
                [
                  73.29098582267761,
                  55.03883763879252
                ],
                [
                  73.29295456409454,
                  55.04205590839878
                ],
                [
                  73.32019507884979,
                  55.0581433784402
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.28049302101135,
                  55.022075097061574
                ],
                [
                  73.29098582267761,
                  55.03880689953638
                ],
                [
                  73.27257513999939,
                  55.045550527252836
                ],
                [
                  73.26812267303467,
                  55.05135270373374
                ],
                [
                  73.22979927062988,
                  55.02300379987702
                ],
                [
                  73.2406997680664,
                  55.02187213265418
                ],
                [
                  73.25202941894531,
                  55.02285619292062
                ],
                [
                  73.28049302101135,
                  55.022075097061574
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.26464653015137,
                  55.064644139750854
                ],
                [
                  73.24473381042479,
                  55.087996385640494
                ],
                [
                  73.16173553466797,
                  55.06568858707089
                ],
                [
                  73.17375183105469,
                  55.05094092443126
                ],
                [
                  73.1989860534668,
                  55.0319576052081
                ],
                [
                  73.22974026203156,
                  55.02302532584606
                ],
                [
                  73.2679831981659,
                  55.05141416296794
                ],
                [
                  73.2816731929779,
                  55.05496020103541
                ],
                [
                  73.26443195343018,
                  55.06450283007894
                ],
                [
                  73.26464653015137,
                  55.064644139750854
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.29885005950928,
                  54.977638299652334
                ],
                [
                  73.30569505691528,
                  54.971606832936466
                ],
                [
                  73.33288192749023,
                  54.97584034615842
                ],
                [
                  73.33751678466797,
                  54.97219493310148
                ],
                [
                  73.3421516418457,
                  54.972244197645836
                ],
                [
                  73.35923194885254,
                  54.97776144420598
                ],
                [
                  73.34283828735352,
                  54.990960350133236
                ],
                [
                  73.32634806632996,
                  54.99755817574595
                ],
                [
                  73.29885005950928,
                  54.977638299652334
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.34240913391113,
                  54.9722380395811
                ],
                [
                  73.35064888000488,
                  54.96162629153143
                ],
                [
                  73.3505630493164,
                  54.94891067496699
                ],
                [
                  73.35601329803467,
                  54.949378957004654
                ],
                [
                  73.36172103881836,
                  54.95674751904885
                ],
                [
                  73.36923122406006,
                  54.961848039841584
                ],
                [
                  73.37060451507568,
                  54.96852455458447
                ],
                [
                  73.36918830871582,
                  54.97130816096891
                ],
                [
                  73.35926413536072,
                  54.97767524305807
                ],
                [
                  73.34240913391113,
                  54.9722380395811
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.34228038787842,
                  54.972121036171615
                ],
                [
                  73.34184050559998,
                  54.97220109117283
                ],
                [
                  73.33754897117615,
                  54.97213951041682
                ],
                [
                  73.34047794342041,
                  54.96128134728288
                ],
                [
                  73.33910465240477,
                  54.95154777108256
                ],
                [
                  73.35051745176315,
                  54.94891375578769
                ],
                [
                  73.35034847259521,
                  54.96165093029301
                ],
                [
                  73.34228038787842,
                  54.972121036171615
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.49665760993958,
                  54.939020023488965
                ],
                [
                  73.44150066375732,
                  54.93066807752845
                ],
                [
                  73.44128608703613,
                  54.93072972185925
                ],
                [
                  73.43557834625244,
                  54.93092698308303
                ],
                [
                  73.43450546264648,
                  54.90592874879748
                ],
                [
                  73.49784851074219,
                  54.907113031299716
                ],
                [
                  73.49665760993958,
                  54.939020023488965
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.43443036079407,
                  54.90593491702577
                ],
                [
                  73.43553006649016,
                  54.930911572084774
                ],
                [
                  73.39656561613083,
                  54.93216138486568
                ],
                [
                  73.37886571884155,
                  54.90274581694464
                ],
                [
                  73.39056015014648,
                  54.90400421542749
                ],
                [
                  73.43443036079407,
                  54.90593491702577
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.39621156454085,
                  54.93220607535567
                ],
                [
                  73.3555519580841,
                  54.9352788127154
                ],
                [
                  73.3458423614502,
                  54.92669798366578
                ],
                [
                  73.34043502807617,
                  54.920433809029554
                ],
                [
                  73.33683013916016,
                  54.917079361842056
                ],
                [
                  73.33245277404785,
                  54.906372858818415
                ],
                [
                  73.378586769104,
                  54.90274581694464
                ],
                [
                  73.39621156454085,
                  54.93220607535567
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.29627513885498,
                  55.013875747425
                ],
                [
                  73.27940940856934,
                  55.01535212320113
                ],
                [
                  73.27649116516113,
                  55.01262078527431
                ],
                [
                  73.26958179473877,
                  55.01318675345945
                ],
                [
                  73.2667064666748,
                  55.00056130421191
                ],
                [
                  73.277907371521,
                  54.999995157843365
                ],
                [
                  73.29627513885498,
                  55.013875747425
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.27784299850464,
                  54.99993361971322
                ],
                [
                  73.26669573783875,
                  55.000518228138596
                ],
                [
                  73.25408935546875,
                  54.98871979695422
                ],
                [
                  73.2603120803833,
                  54.988448952381816
                ],
                [
                  73.26275825500488,
                  54.98871979695422
                ],
                [
                  73.26619148254395,
                  54.99000012837275
                ],
                [
                  73.27784299850464,
                  54.99993361971322
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.21383476257324,
                  55.005090187548774
                ],
                [
                  73.20834159851074,
                  54.998272054518296
                ],
                [
                  73.23263168334961,
                  54.99002474973051
                ],
                [
                  73.24190139770508,
                  55.00257967407423
                ],
                [
                  73.21383476257324,
                  55.005090187548774
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.23269605636597,
                  54.99001243905352
                ],
                [
                  73.25405716896057,
                  54.988738263563036
                ],
                [
                  73.26644897460938,
                  55.00085668175435
                ],
                [
                  73.24196577072144,
                  55.002570443955385
                ],
                [
                  73.23269605636597,
                  54.99001243905352
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.3263386785984,
                  54.99755971429144
                ],
                [
                  73.2962965965271,
                  55.013863444065144
                ],
                [
                  73.27799320220947,
                  54.999995157843365
                ],
                [
                  73.26627194881439,
                  54.9899816623445
                ],
                [
                  73.26303720474243,
                  54.98875673016338
                ],
                [
                  73.26456069946289,
                  54.98721781765382
                ],
                [
                  73.29490184783936,
                  54.970199668268215
                ],
                [
                  73.30559849739075,
                  54.971597595692415
                ],
                [
                  73.29868912696838,
                  54.97769371474819
                ],
                [
                  73.3263386785984,
                  54.99755971429144
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.35599720478058,
                  54.94936663386305
                ],
                [
                  73.35034847259521,
                  54.948861381803546
                ],
                [
                  73.33910465240477,
                  54.95152004550473
                ],
                [
                  73.31588745117188,
                  54.932714618813236
                ],
                [
                  73.33511352539062,
                  54.92536631163654
                ],
                [
                  73.35485458374023,
                  54.941195559311794
                ],
                [
                  73.35599720478058,
                  54.94936663386305
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.3388900756836,
                  54.951523126125416
                ],
                [
                  73.33706617355347,
                  54.95253355697625
                ],
                [
                  73.33828926086426,
                  54.9534330655061
                ],
                [
                  73.33318233489989,
                  54.95769313550191
                ],
                [
                  73.32942724227905,
                  54.95860792893863
                ],
                [
                  73.32296848297119,
                  54.95424630246394
                ],
                [
                  73.33457708358765,
                  54.9479371237963
                ],
                [
                  73.3388900756836,
                  54.951523126125416
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.32290410995483,
                  54.954184694179645
                ],
                [
                  73.31116676330565,
                  54.94666777483153
                ],
                [
                  73.29906463623047,
                  54.947210025895394
                ],
                [
                  73.293399810791,
                  54.94297041352634
                ],
                [
                  73.31923484802246,
                  54.935599325457964
                ],
                [
                  73.33452343940735,
                  54.947912476625184
                ],
                [
                  73.32290410995483,
                  54.954184694179645
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.293399810791,
                  54.94289646283169
                ],
                [
                  73.29133987426758,
                  54.89832877373636
                ],
                [
                  73.31897735595703,
                  54.8937878444101
                ],
                [
                  73.3350920677185,
                  54.925316989603736
                ],
                [
                  73.31511497497559,
                  54.932862557520764
                ],
                [
                  73.31854820251465,
                  54.9356239801785
                ],
                [
                  73.293399810791,
                  54.94289646283169
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.20825576782227,
                  54.998198205579136
                ],
                [
                  73.19074630737305,
                  54.98194813431667
                ],
                [
                  73.24224472045898,
                  54.96283357307885
                ],
                [
                  73.2643461227417,
                  54.98704545577841
                ],
                [
                  73.26292991638184,
                  54.98857206377767
                ],
                [
                  73.26061248779297,
                  54.98832584060835
                ],
                [
                  73.23241710662842,
                  54.98980315696681
                ],
                [
                  73.20825576782227,
                  54.998198205579136
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.26456069946289,
                  54.986922339699966
                ],
                [
                  73.24250221252441,
                  54.96283357307885
                ],
                [
                  73.26404571533203,
                  54.9566243100548
                ],
                [
                  73.27305793762207,
                  54.96322777960449
                ],
                [
                  73.28224182128906,
                  54.96431182760502
                ],
                [
                  73.2835292816162,
                  54.96721890282564
                ],
                [
                  73.28713417053221,
                  54.96933748612686
                ],
                [
                  73.294837474823,
                  54.97018889110567
                ],
                [
                  73.26456069946289,
                  54.986922339699966
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.38528156280518,
                  55.00143512314196
                ],
                [
                  73.40489387512207,
                  55.024529039932304
                ],
                [
                  73.40476512908936,
                  55.02476274094208
                ],
                [
                  73.42643737792969,
                  55.04312246028798
                ],
                [
                  73.4083217382431,
                  55.05123132146906
                ],
                [
                  73.37706327438354,
                  55.028427978500396
                ],
                [
                  73.37689161300659,
                  55.028477174040255
                ],
                [
                  73.36002588272095,
                  55.01531521446924
                ],
                [
                  73.38528156280518,
                  55.00143512314196
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.33287388086319,
                  54.97583264926665
                ],
                [
                  73.30569874495268,
                  54.97160452362566
                ],
                [
                  73.29490184783936,
                  54.9701873515108
                ],
                [
                  73.28716099262238,
                  54.96931285207945
                ],
                [
                  73.2835990190506,
                  54.967209664572394
                ],
                [
                  73.28225791454315,
                  54.96429334975915
                ],
                [
                  73.27307134866714,
                  54.96320930126001
                ],
                [
                  73.27340126037598,
                  54.96203282916512
                ],
                [
                  73.27463507652283,
                  54.961657089981024
                ],
                [
                  73.27758550643921,
                  54.96189731707762
                ],
                [
                  73.2867693901062,
                  54.96002473961785
                ],
                [
                  73.29037964344025,
                  54.95574181459165
                ],
                [
                  73.2996118068695,
                  54.95549693021652
                ],
                [
                  73.30805271863937,
                  54.956699775608506
                ],
                [
                  73.30950379371643,
                  54.95605754381635
                ],
                [
                  73.31150874495505,
                  54.9547699690673
                ],
                [
                  73.31852674484253,
                  54.95812743397263
                ],
                [
                  73.32942724227905,
                  54.95871881157635
                ],
                [
                  73.33335399627686,
                  54.95774549797775
                ],
                [
                  73.33835631608963,
                  54.95342998503179
                ],
                [
                  73.3371251821518,
                  54.95253817779069
                ],
                [
                  73.33890214562415,
                  54.95154315015425
                ],
                [
                  73.3390885591507,
                  54.951553932319506
                ],
                [
                  73.34035992622375,
                  54.96128750702758
                ],
                [
                  73.33734512329102,
                  54.97218261695595
                ],
                [
                  73.33287388086319,
                  54.97583264926665
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.30556631088255,
                  55.07500139436755
                ],
                [
                  73.32054376602173,
                  55.058284710564685
                ],
                [
                  73.3678150177002,
                  55.04821815770448
                ],
                [
                  73.40901374816895,
                  55.0657254494195
                ],
                [
                  73.30556631088255,
                  55.07500139436755
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.40839147567749,
                  55.05124207687445
                ],
                [
                  73.42657685279846,
                  55.043165490603954
                ],
                [
                  73.47540378570557,
                  55.04143809445904
                ],
                [
                  73.47552180290222,
                  55.04157948555474
                ],
                [
                  73.41926515102386,
                  55.059181850675024
                ],
                [
                  73.40839147567749,
                  55.05124207687445
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.47557008266449,
                  55.041564116981554
                ],
                [
                  73.47538232803345,
                  55.041364324993616
                ],
                [
                  73.45149457454681,
                  55.02305300207502
                ],
                [
                  73.45153748989105,
                  55.02289616985833
                ],
                [
                  73.45234751701355,
                  54.99736124143556
                ],
                [
                  73.49083185195923,
                  54.97845104672708
                ],
                [
                  73.47557008266449,
                  55.041564116981554
                ]
              ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {},
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [
                  73.26473504304884,
                  55.064601132512195
                ],
                [
                  73.3053906261921,
                  55.07498757419491
                ],
                [
                  73.24478477239609,
                  55.088004061018026
                ],
                [
                  73.26473504304884,
                  55.064601132512195
                ]
              ]
            ]
          }
        }
      ]
    }

    json.features.forEach(res => {
      res.geometry.coordinates.forEach(coord => {
        const newCoord = this.centerByPolygon(coord);
        this.sensorsService.getSensordAir(newCoord)
          .subscribe(sensor => {
            Object.keys(sensor).forEach(_sensor => {
              if (_sensor === 'list') {
                Object.keys(sensor[_sensor]).forEach(__sensor => {
                  coord.map(i => [i[0], i[1]] = [i[1], i[0]]);
                  var myPolygon4 = new ymaps.Polygon(
                    [coord], 
                    {
                      balloonContent:
                      `
                      <h2>Прогноз индекса загрязненности воздуха</h2>
                      <div class="card" style="width: 100%;">
                        <div class="card-body">
                          <h3 class="card-title">
                            Прогноз на ${moment().format('l')}
                          </h3>
                          <p class="card-text">Скоро здесь будет прогноз..</p>
                        </div>
                      </div>
                    `
                    ,
                      hintContent: `
                        <div class="card">
                          <h4 class="card-title" style="margin: 10px">Индекс загрязненности: <b>${sensor[_sensor][__sensor].main.aqi.toString()}</b></h4>
                          <ul class="list-group list-group-flush">
                            <li class="list-group-item">Монооксид углерода: <b>${sensor[_sensor][__sensor].components.co} мкг/м<sup><small>3</small></sup></b></li>
                            <li class="list-group-item">Оксид азота: <b>${sensor[_sensor][__sensor].components.no} мкг/м<sup><small>3</small></sup></b></li>
                            <li class="list-group-item">Двуокись азота: <b>${sensor[_sensor][__sensor].components.no2} мкг/м<sup><small>3</small></sup></b></li>
                            <li class="list-group-item">Озон: <b>${sensor[_sensor][__sensor].components.o3} мкг/м<sup><small>3</small></sup></b></li>
                            <li class="list-group-item">Оксид серы: <b>${sensor[_sensor][__sensor].components.so2} мкг/м<sup><small>3</small></sup></b></li>
                            <li class="list-group-item">Частицы РМ2.5 (мелкие твердые частицы и капли жидкости): <b>${sensor[_sensor][__sensor].components.pm2_5} мкг/м<sup><small>3</small></sup></b></li>
                            <li class="list-group-item">Частицы РМ10 (крупные и грубые частицы): <b>${sensor[_sensor][__sensor].components.pm10} мкг/м<sup><small>3</small></sup></b></li>
                            <li class="list-group-item">Аммиак: <b>${sensor[_sensor][__sensor].components.nh3} мкг/м<sup><small>3</small></sup></b></li>
                          </ul>
                        </div>
                      `
                    }, 
                    {
                    fillColor: 
                    sensor[_sensor][__sensor].main.aqi == 1
                    ? ColorAir.Well
                    : sensor[_sensor][__sensor].main.aqi == 2
                    ? ColorAir.Medium
                    : sensor[_sensor][__sensor].main.aqi == 3
                    ? ColorAir.Bad
                    : sensor[_sensor][__sensor].main.aqi == 4
                    ? ColorAir.VeryBad : ColorAir.VeryVeryBad,
                    strokeWidth: 1,
                    opacity: 0.8
                  });
                  
                  myPolygon4.events
                    .add('mouseenter', () => {
                      myPolygon4.options.set('strokeColor', '#dc3545');
                      myPolygon4.options.set('strokeWidth', 3);
                    })
                    .add('mousedown', () => {
                      this.doForecasts(newCoord);
                    })
                    .add('mouseleave', ()=> {
                      myPolygon4.options.unset('strokeColor');
                      myPolygon4.options.unset('strokeWidth');
                    })
                  myMap.geoObjects.add(myPolygon4);
                })
              }
            })
          });
      });
    });
  }

  public centerByPolygon(coord: number[][]): Array<number> {
    var minX, maxX, minY, maxY;
    for (var i = 0; i < coord.length; i++)
    {
        minX = (coord[i][0] < minX || minX == null) ? coord[i][0] : minX;
        maxX = (coord[i][0] > maxX || maxX == null) ? coord[i][0] : maxX;
        minY = (coord[i][1] < minY || minY == null) ? coord[i][1] : minY;
        maxY = (coord[i][1] > maxY || maxY == null) ? coord[i][1] : maxY;
    }
    return [(minY + maxY) / 2, (minX + maxX) / 2];
  }

  public getDateNow(a): string {
    return a;
  }
/* Вычисление среднего значения */
  // public calcAverageValue(arrCoord: number[][], centerCoord: number[]): number {
  //   let newArr = [...arrCoord, [...centerCoord]];
  //   newArr.forEach(arr => {
  //     this.sensorsService.getSensordAir([arr[0], arr[1]])
  //       .subscribe(sensor => {
  //         Object.keys(sensor).forEach(_sensor => {
  //           if (_sensor === 'list') {
  //             Object.keys(sensor[_sensor]).forEach(__sensor => {
  //               console.log('1',_sensor)
  //             });
  //           }
  //         });
  //       });
  //   })
  //   return 0;
  // }
}
